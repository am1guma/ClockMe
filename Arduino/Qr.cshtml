@using ClockMe.QRGenerator
@using Newtonsoft.Json
@model ClockMe.Models.Qr
@{
    ViewBag.Title = "Qr";
}


@section Scripts {
    <script type="text/javascript">
        $(function() {
            function imageToStringHorizontal(image) {

                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                canvas.width = 100;
                canvas.height = 100;
                context.drawImage(image, 0, 0);

                var imageData = context.getImageData(0, 0, 100, 100);

                var output_string = "";
                var output_index = 0;

                var byteIndex = 7;
                var number = 0;

                for (var index = 0; index < imageData.data.length; index += 4) {
                    var avg = (imageData.data[index] + imageData.data[index + 1] + imageData.data[index + 2]) / 3;
                    if (avg > 128) {
                        number += Math.pow(2, byteIndex);
                    }
                    byteIndex--;

                    if (index == imageData.data.length - 4) {
                        for (var i = byteIndex; i > -1; i--) {
                            number += Math.pow(2, i);
                        }
                        byteIndex = -1;
                    }

                    if (byteIndex < 0) {
                        var byteSet = number.toString(16);
                        if (byteSet.length == 1) {
                            byteSet = "0" + byteSet;
                        }
                        var b = "0x" + byteSet;
                        output_string += b + ", ";
                        output_index++;
                        if (output_index >= 16) {
                            output_string += "\n";
                            output_index = 0;
                        }
                        number = 0;
                        byteIndex = 7;
                    }
                }
                return output_string;
            }

            document.write('@Html.GenerateQrCode("http://www.google.com")');
            var output_String = imageToStringHorizontal(document.getElementById("qrcode"));
            output_String = output_String.replace(/,\s*$/gm, "");
            var qr = {
                "QrBytes": "test"
            }
            var UserData = { "QrBytes": "test" }
            $.ajax({
                url: '@Url.Action("Temp","Arduino")',
                method: 'POST',
                contentType: "application/json",
                data: JSON.stringify(UserData)
            });
        });
    </script>
}
